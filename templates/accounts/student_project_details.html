{% extends 'base.html' %}
{% load static %}

{% block content %}
{% csrf_token %}
<link rel="stylesheet" href="{% static 'accounts/admin_sidebar.css' %}">
<link rel="stylesheet" href="{% static 'accounts/projects.css' %}">
<link rel="stylesheet" href="{% static 'accounts/project-details.css' %}">

<button class="hamburger-btn d-lg-none" id="openSidebarBtn" aria-label="Open sidebar">
    <svg width="32" height="32" fill="#222" viewBox="0 0 16 16"><path d="M2 12.5a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z"/></svg>
</button>
<div class="sidebar-overlay" id="sidebarOverlay"></div>
<div class="admin-sidebar" id="adminSidebar">
    <div class="logo-row">
        <img src="{% static 'accounts/vtslogo.jpg' %}" alt="Logo">
        <span>VTS Developers</span>
        <button class="close-btn d-lg-none" id="closeSidebarBtn" aria-label="Close sidebar">
            &times;
        </button>
    </div>
    <nav class="nav flex-column">
        <a class="nav-link" href="{% url 'student_home' %}">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 12L5 10M5 10L12 3L19 10M5 10V20C5 20.2652 5.10536 20.5196 5.29289 20.7071C5.48043 20.8946 5.73478 21 6 21H9M19 10L21 12M19 10V20C19 20.2652 18.8946 20.5196 18.7071 20.7071C18.5196 20.8946 18.2652 21 18 21H15M9 21C9.26522 21 9.51957 20.8946 9.70711 20.7071C9.89464 20.5196 10 20.2652 10 20V16C10 15.7348 10.1054 15.4804 10.2929 15.2929C10.4804 15.1054 10.7348 15 11 15H13C13.2652 15 13.5196 15.1054 13.7071 15.2929C13.8946 15.4804 14 15.7348 14 16V20C14 20.2652 14.1054 20.5196 14.2929 20.7071C14.4804 20.8946 14.7348 21 15 21M9 21H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>Home</span>
        </a>
        <a class="nav-link" href="{% url 'public_student_projects' %}">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M7 7H7.01M7 3H12C12.5119 2.99999 13.0237 3.19399 13.4142 3.58579L20.4143 10.5858C21.1953 11.3668 21.1953 12.6332 20.4143 13.4142L13.4142 20.4142C12.6332 21.1953 11.3668 21.1953 10.5858 20.4142L3.58579 13.4142C3.19399 13.0237 2.99999 12.5119 3 12V7C3 4.79086 4.79086 3 7 3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>All Projects</span>
        </a>
    </nav>
</div>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="project-details-card card shadow">
                <div class="card-body">
                    <header class="project-header">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="project-title-section">
                                <h3 class="card-title">{{ project.title }}</h3>
                                <div class="project-meta-info">
                                    <a href="#" class="text-decoration-none author-link">
                                        <span class="author-name">{{ project.student.student_name }}</span>
                                    </a>
                                    <span class="meta-divider">â€¢</span>
                                    <span class="project-time">{{ project.created_at|timesince }} ago</span>
                                </div>
                            </div>
                            <div class="project-actions-top d-flex gap-3 align-items-center">
                                {% if project.student.user != request.user %}
                                <button class="like-btn" data-project-id="{{ project.id }}" data-liked="{{ project.is_liked_by|yesno:'true,false' }}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-heart-fill {% if project.is_liked_by %}text-danger{% endif %}" viewBox="0 0 16 16">
                                        <path d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314"/>
                                    </svg>
                                    <span class="like-count">{{ project.like_count }}</span>
                                </button>

                                <button class="btn follow-btn {% if is_following %}btn-following{% else %}btn-follow{% endif %}" 
                                        data-student-id="{{ project.student.id }}" 
                                        data-following="{{ is_following|yesno:'true,false' }}">
                                    <span class="follow-text">{% if is_following %}Following{% else %}Follow{% endif %}</span>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </header>

                    {% if project.screenshot %}
                    <div class="project-screenshot-container">
                        <img src="{{ project.screenshot.url }}" class="project-screenshot" alt="Project Screenshot">
                    </div>
                    {% endif %}

                    <div class="project-info-grid">
                        <div class="project-description">
                            <h5>About This Project</h5>
                            <p>{{ project.description }}</p>
                        </div>

                        <div class="project-meta">
                            {% if project.category %}
                            <div class="meta-section">
                                <h6>Category</h6>
                                <span class="badge category-badge">{{ project.category }}</span>
                            </div>
                            {% endif %}

                            {% if project.tags %}
                            <div class="meta-section">
                                <h6>Technologies</h6>
                                <div class="tags-container">
                                    {% for tag in project.tags.split %}
                                    <span class="badge tag-badge">{{ tag }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <div class="project-stats">
                            <div class="stat-item">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye" viewBox="0 0 16 16">
                                    <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                                    <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
                                </svg>
                                <span>{{ project.view_count }} views</span>
                            </div>
                            <div class="stat-item">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-heart" viewBox="0 0 16 16">
                                    <path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01L8 2.748zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143c.06.055.119.112.176.171a3.12 3.12 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15z"/>
                                </svg>
                                <span class="total-likes">{{ project.like_count }} likes</span>
                            </div>
                        </div>

                        <div class="project-actions">
                            <div class="action-buttons">
                                {% if project.project_link %}
                                <a href="{{ project.project_link }}" target="_blank" class="btn btn-code">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-code-slash" viewBox="0 0 16 16">
                                        <path d="M10.478 1.647a.5.5 0 1 0-.956-.294l-4 13a.5.5 0 0 0 .956.294l4-13zM4.854 4.146a.5.5 0 0 1 0 .708L1.707 8l3.147 3.146a.5.5 0 0 1-.708.708l-3.5-3.5a.5.5 0 0 1 0-.708l3.5-3.5a.5.5 0 0 1 .708 0zm6.292 0a.5.5 0 0 0 0 .708L14.293 8l-3.147 3.146a.5.5 0 0 0 .708.708l3.5-3.5a.5.5 0 0 0 0-.708l-3.5-3.5a.5.5 0 0 0-.708 0z"/>
                                    </svg>
                                    View Code
                                </a>
                                {% endif %}
                                {% if project.output_link %}
                                <a href="{{ project.output_link }}" target="_blank" class="btn btn-demo">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-play-fill" viewBox="0 0 16 16">
                                        <path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/>
                                    </svg>
                                    View Live Demo
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle project likes
    document.querySelector('.like-btn')?.addEventListener('click', async function(e) {
        e.preventDefault();
        const projectId = this.dataset.projectId;
        
        try {
            const response = await fetch(`/accounts/project/${projectId}/like/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
            });
            const data = await response.json();
            
            if (data.success) {
                const heartIcon = this.querySelector('.bi-heart-fill');
                const likeCount = this.querySelector('.like-count');
                const totalLikes = document.querySelector('.total-likes');
                
                if (data.liked) {
                    heartIcon.classList.add('text-danger');
                } else {
                    heartIcon.classList.remove('text-danger');
                }
                
                likeCount.textContent = data.likeCount;
                totalLikes.textContent = data.likeCount;
            }
        } catch (error) {
            console.error('Error:', error);
        }
    });

    // Handle follow/unfollow
    document.querySelector('.follow-btn')?.addEventListener('click', async function(e) {
        e.preventDefault();
        const studentId = this.dataset.studentId;
        const followText = this.querySelector('.follow-text');
        
        try {
            const response = await fetch(`/accounts/student/${studentId}/follow/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
            });
            const data = await response.json();
            
            if (data.success) {
                const isFollowing = data.following;
                followText.textContent = isFollowing ? 'Following' : 'Follow';
                this.classList.toggle('btn-secondary', isFollowing);
                this.classList.toggle('btn-outline-primary', !isFollowing);
                this.dataset.following = isFollowing;
            }
        } catch (error) {
            console.error('Error:', error);
        }
    });
});

// Sidebar functionality
document.addEventListener('DOMContentLoaded', function() {
    const openSidebarBtn = document.getElementById('openSidebarBtn');
    const closeSidebarBtn = document.getElementById('closeSidebarBtn');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const adminSidebar = document.getElementById('adminSidebar');

    function openSidebar() {
        adminSidebar.classList.add('show');
        sidebarOverlay.classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    function closeSidebar() {
        adminSidebar.classList.remove('show');
        sidebarOverlay.classList.remove('show');
        document.body.style.overflow = '';
    }

    openSidebarBtn.addEventListener('click', openSidebar);
    closeSidebarBtn.addEventListener('click', closeSidebar);
    sidebarOverlay.addEventListener('click', closeSidebar);
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var openBtn = document.getElementById('openSidebarBtn');
    var closeBtn = document.getElementById('closeSidebarBtn');
    var sidebar = document.getElementById('adminSidebar');
    var overlay = document.getElementById('sidebarOverlay');
    function openSidebar() {
        sidebar.classList.add('sidebar-open');
        sidebar.classList.add('show');
        overlay.classList.add('show');
        overlay.style.display = 'block';
    }
    function closeSidebar() {
        sidebar.classList.remove('sidebar-open');
        sidebar.classList.remove('show');
        overlay.classList.remove('show');
        overlay.style.display = 'none';
    }
    if (openBtn) openBtn.onclick = openSidebar;
    if (closeBtn) closeBtn.onclick = closeSidebar;
    if (overlay) overlay.onclick = closeSidebar;
});
</script>
{% endblock %}