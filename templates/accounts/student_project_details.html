{% extends 'base.html' %}
{% load static %}

{% block content %}
{% csrf_token %}
<link rel="stylesheet" href="{% static 'accounts/admin_sidebar.css' %}">
<link rel="stylesheet" href="{% static 'accounts/projects.css' %}">
<link rel="stylesheet" href="{% static 'accounts/project-cards.css' %}">
<link rel="stylesheet" href="{% static 'accounts/project-details.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<!-- Mobile Sidebar Toggle -->
<button class="hamburger-btn d-lg-none" id="openSidebarBtn" aria-label="Open sidebar">
    <svg width="32" height="32" fill="#222" viewBox="0 0 16 16"><path d="M2 12.5a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z"/></svg>
</button>

<!-- Sidebar Overlay -->
<div class="sidebar-overlay sidebar-overlay-custom" id="sidebarOverlay"></div>

<!-- Admin Sidebar -->
<div class="admin-sidebar" id="adminSidebar">
    <div class="logo-row">
        <img src="{% static 'accounts/vtslogo.jpg' %}" alt="Logo">
        <span>VTS Developers</span>
        <button class="close-btn d-lg-none close-btn-custom" id="closeSidebarBtn" aria-label="Close sidebar">
            &times;
        </button>
    </div>
    <nav class="nav flex-column">
        <a class="nav-link active" href="#">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="svg-middle">
                <path d="M23.9937 11.9766C23.9937 12.8203 23.3687 13.4813 22.6603 13.4813H21.3268L21.356 20.9906C21.356 21.1172 21.3476 21.2437 21.3351 21.3703V22.125C21.3351 23.1609 20.5893 24 19.6683 24H19.0016C18.9558 24 18.9099 24 18.8641 23.9953C18.8058 24 18.7474 24 18.6891 24H17.3348H16.3347C15.4138 24 14.6679 23.1609 14.6679 22.125V21V18C14.6679 17.1703 14.072 16.5 13.3345 16.5H10.6676C9.93001 16.5 9.33413 17.1703 9.33413 18V21V22.125C9.33413 23.1609 8.58823 24 7.66732 24H6.66723H5.33795C5.27545 24 5.21294 23.9953 5.15044 23.9906C5.10043 23.9953 5.05043 24 5.00043 24H4.3337C3.41279 24 2.66689 23.1609 2.66689 22.125V16.875C2.66689 16.8328 2.66689 16.7859 2.67106 16.7438V13.4813H1.33345C0.583383 13.4813 0 12.825 0 11.9766C0 11.5547 0.125011 11.1797 0.416702 10.8516L11.1009 0.375C11.3926 0.046875 11.726 0 12.0177 0C12.3094 0 12.6427 0.09375 12.8928 0.328125L23.5353 10.8516C23.8687 11.1797 24.0354 11.5547 23.9937 11.9766Z" fill="black"/>
            </svg>
            <span class="overview-label">Overview</span>
        </a>
        <a class="nav-link" href="{% url 'admin_projects' %}">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="svg-middle">
                <path d="M13.5 5.12252V16.4996C13.5 17.3294 12.8297 17.9997 12 17.9997C11.1703 17.9997 10.5 17.3294 10.5 16.4996V5.12252L7.05938 8.56331C6.47344 9.14927 5.52188 9.14927 4.93594 8.56331C4.35 7.97734 4.35 7.02573 4.93594 6.43977L10.9359 0.439475C11.5219 -0.146492 12.4734 -0.146492 13.0594 0.439475L19.0594 6.43977C19.6453 7.02573 19.6453 7.97734 19.0594 8.56331C18.4734 9.14927 17.5219 9.14927 16.9359 8.56331L13.5 5.12252ZM3 16.4996H9C9 18.1544 10.3453 19.4998 12 19.4998C13.6547 19.4998 15 18.1544 15 16.4996H21C22.6547 16.4996 24 17.845 24 19.4998V20.9999C24 22.6546 22.6547 24 21 24H3C1.34531 24 0 22.6546 0 20.9999V19.4998C0 17.845 1.34531 16.4996 3 16.4996ZM20.25 21.3749C20.5484 21.3749 20.8345 21.2563 21.0455 21.0453C21.2565 20.8344 21.375 20.5482 21.375 20.2498C21.375 19.9514 21.2565 19.6653 21.0455 19.4543C20.8345 19.2433 20.5484 19.1248 20.25 19.1248C19.9516 19.1248 19.6655 19.2433 19.4545 19.4543C19.2435 19.6653 19.125 19.9514 19.125 20.2498C19.125 20.5482 19.2435 20.8344 19.4545 21.0453C19.6655 21.2563 19.9516 21.3749 20.25 21.3749Z" fill="white"/>
            </svg>
            <span class="projects-label">Projects</span>
        </a>
        <a class="nav-link" href="{% url 'admin_profiles' %}">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="svg-middle">
                <path d="M3 24H21C22.6547 24 24 22.4625 24 20.5714V6.85714C24 4.96607 22.6547 3.42857 21 3.42857H13.5C13.0266 3.42857 12.5812 3.17679 12.3 2.74286L11.4 1.37143C10.8328 0.508928 9.94219 0 9 0H3C1.34531 0 0 1.5375 0 3.42857V20.5714C0 22.4625 1.34531 24 3 24Z" fill="#374151"/>
            </svg>
            <span class="profile-label">Profile</span>
        </a>
        <a class="nav-link" href="#" id="addStudentBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm4.216 1.447A2.5 2.5 0 0 1 15 10.5V12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1v-1.5a2.5 2.5 0 0 1 2.784-2.553A4.992 4.992 0 0 1 8 9c1.306 0 2.417-.417 3.216-1.553zM8 10a3.978 3.978 0 0 0-3.468 2H13.468A3.978 3.978 0 0 0 8 10z"/>
            </svg>
            Add Students
        </a>
    </nav>
    <form method="post" action="/accounts/logout/" class="logout-form">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger w-100 btn-logout">Logout</button>
    </form>
</div>

<div class="main-content">
    {% if is_admin %}
    <!-- Admin View: Student's All Projects -->
    <div class="admin-projects-container">
        <div class="page-header">
            <div class="header-content">
                <div class="student-info">
                    <div class="student-avatar">
                        {% if student.image %}
                            <img src="{{ student.image.url }}" alt="{{ student.student_name }}" class="avatar-img">
                        {% else %}
                            <div class="avatar-placeholder">
                                <i class="fas fa-user"></i>
                            </div>
                        {% endif %}
                    </div>
                    <div class="student-details">
                        <h1 class="student-name">{{ student.student_name }}</h1>
                        <p class="student-meta">{{ student.student_email }}</p>
                    </div>
                </div>
                <div class="project-count">
                    <span class="count-number">{{ projects|length }}</span>
                    <span class="count-label">Projects</span>
                </div>
            </div>
        </div>

        <div class="projects-grid">
            {% for project in projects %}
            <div class="project-card-modern">
                <div class="project-image-container">
                    {% if project.screenshot %}
                        {% if project.output_link %}
                        <a href="{{ project.output_link }}" target="_blank" class="screenshot-link" onclick="recordProjectView({{ project.id }}, event); return true;">
                            <img src="{{ project.screenshot.url }}" alt="{{ project.title }}" class="project-image">
                            <div class="screenshot-overlay">
                                <i class="fas fa-external-link-alt"></i>
                                <span>Click to view demo</span>
                            </div>
                        </a>
                        {% else %}
                        <img src="{{ project.screenshot.url }}" alt="{{ project.title }}" class="project-image">
                        {% endif %}
                    {% else %}
                        <div class="no-image-placeholder">
                            <i class="fas fa-code"></i>
                            <span>No Preview</span>
                        </div>
                    {% endif %}
                    <div class="project-overlay">
                        <div class="project-stats-mini">
                            <span class="stat-item">
                                <i class="fas fa-eye"></i>
                                {{ project.view_count }}
                            </span>
                            <span class="stat-item">
                                <i class="fas fa-heart"></i>
                                {{ project.like_count }}
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="project-content">
                    <div class="project-header">
                        <h3 class="project-title">{{ project.title }}</h3>
                        <div class="project-category">{{ project.category }}</div>
                    </div>
                    
                    <p class="project-description">{{ project.description|truncatechars:120 }}</p>
                    
                    <div class="project-meta">
                        <span class="project-date">
                            <i class="fas fa-calendar"></i>
                            {{ project.created_at|timesince }} ago
                        </span>
                        {% if project.tags %}
                        <div class="project-tags">
                            {% for tag in project.tags.split %}
                                <span class="tag">{{ tag }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="project-actions">
                        {% if project.project_link %}
                        <a href="{{ project.project_link }}" target="_blank" class="action-btn btn-code">
                            <i class="fas fa-code"></i>
                            Code
                        </a>
                        {% endif %}
                        {% if project.output_link %}
                        <a href="{{ project.output_link }}" target="_blank" class="action-btn btn-demo">
                            <i class="fas fa-external-link-alt"></i>
                            Demo
                        </a>
                        {% endif %}
                        <button class="action-btn btn-hire" onclick="handleHireNow('{{ student.student_name }}', '{{ project.title }}', {{ project.id }})">
                            <i class="fas fa-user-plus"></i>
                            Hire Now
                        </button>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-folder-open"></i>
                </div>
                <h3>No Projects Yet</h3>
                <p>This student hasn't uploaded any projects yet.</p>
            </div>
            {% endfor %}
        </div>
    </div>
    
    {% else %}
    <!-- Student View: Single Project Details -->
    <div class="project-details-container">
        <div class="project-details-layout">
            <!-- Project Preview Section -->
            <div class="project-preview-section">
                <div class="preview-card">
                    <div class="preview-image-container">
                        {% if project.screenshot %}
                            {% if project.output_link %}
                            <a href="{{ project.output_link }}" target="_blank" class="screenshot-link" {% if project.student.user != request.user %}onclick="recordProjectView({{ project.id }}, event); return true;"{% endif %}>
                                <img src="{{ project.screenshot.url }}" alt="{{ project.title }}" class="preview-image">
                                <div class="screenshot-overlay">
                                    <i class="fas fa-external-link-alt"></i>
                                    <span>Click to view demo</span>
                                </div>
                            </a>
                            {% else %}
                            <img src="{{ project.screenshot.url }}" alt="{{ project.title }}" class="preview-image">
                            {% endif %}
                        {% else %}
                            <div class="no-preview">
                                <i class="fas fa-code"></i>
                                <span>No Preview Available</span>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="preview-content">
                        <div class="project-header-info">
                            <h1 class="project-main-title">{{ project.title }}</h1>
                            <div class="author-info">
                                <div class="author-avatar">
                                    {% if project.student.image %}
                                        <img src="{{ project.student.image.url }}" alt="{{ project.student.student_name }}" class="author-img">
                                    {% else %}
                                        <div class="author-placeholder">
                                            <i class="fas fa-user"></i>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="author-details">
                                    <span class="author-name">{{ project.student.student_name }}</span>
                                    <span class="author-role">Developer</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="project-stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-eye"></i>
                                </div>
                                <div class="stat-content">
                                    <span class="stat-number">{{ project.view_count }}</span>
                                    <span class="stat-label">Views</span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-heart"></i>
                                </div>
                                <div class="stat-content">
                                    <span class="stat-number">{{ project.like_count }}</span>
                                    <span class="stat-label">Likes</span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="stat-content">
                                    <span class="stat-number">{{ project.created_at|timesince }}</span>
                                    <span class="stat-label">Ago</span>
                                </div>
                            </div>
                        </div>
                        
                        {% if request.user != project.student.user %}
                        <div class="follow-section">
                            <button class="follow-btn-modern {% if is_following %}following{% else %}not-following{% endif %}" 
                                    data-student-id="{{ project.student.id }}" 
                                    data-following="{{ is_following|yesno:'true,false' }}">
                                <i class="fas fa-user-plus"></i>
                                <span class="follow-text">{% if is_following %}Following{% else %}Follow{% endif %}</span>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Project Details Section -->
            <div class="project-details-section">
                <div class="details-card">
                    <div class="details-header">
                        <div class="like-section">
                            {% if request.user != project.student.user %}
                            <button class="like-btn-modern" data-project-id="{{ project.id }}" data-liked="{{ project.is_liked_by|yesno:'true,false' }}">
                                <div class="like-icon {% if project.is_liked_by %}liked{% endif %}">
                                    <i class="fas fa-heart"></i>
                                </div>
                                <span class="like-count">{{ project.like_count }}</span>
                            </button>
                            {% endif %}
                        </div>
                    </div>

                    <div class="details-content">
                        <div class="description-section">
                            <h2 class="section-title">
                                <i class="fas fa-info-circle"></i>
                                About This Project
                            </h2>
                            <div class="description-content">
                                <p>{{ project.description }}</p>
                            </div>
                        </div>

                        <div class="meta-sections">
                            {% if project.category %}
                            <div class="meta-section">
                                <h3 class="meta-title">
                                    <i class="fas fa-tag"></i>
                                    Category
                                </h3>
                                <div class="meta-content">
                                    <span class="category-badge">{{ project.category }}</span>
                                </div>
                            </div>
                            {% endif %}

                            {% if project.tags %}
                            <div class="meta-section">
                                <h3 class="meta-title">
                                    <i class="fas fa-code"></i>
                                    Technologies
                                </h3>
                                <div class="meta-content">
                                    <div class="tags-grid">
                                        {% for tag in project.tags.split %}
                                        <span class="tech-tag">{{ tag }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="action-buttons-section">
                        {% if project.project_link %}
                        <a href="{{ project.project_link }}" target="_blank" class="action-button-modern btn-code" {% if project.student.user != request.user %}onclick="recordProjectView({{ project.id }}, event); return true;"{% endif %}>
                            <div class="btn-icon">
                                <i class="fas fa-code"></i>
                            </div>
                            <div class="btn-content">
                                <span class="btn-title">View Code</span>
                                <span class="btn-subtitle">Source Code</span>
                            </div>
                        </a>
                        {% endif %}
                        {% if project.output_link %}
                        <a href="{{ project.output_link }}" target="_blank" class="action-button-modern btn-demo" {% if project.student.user != request.user %}onclick="recordProjectView({{ project.id }}, event); return true;"{% endif %}>
                            <div class="btn-icon">
                                <i class="fas fa-external-link-alt"></i>
                            </div>
                            <div class="btn-content">
                                <span class="btn-title">Live Demo</span>
                                <span class="btn-subtitle">Try It Out</span>
                            </div>
                        </a>
                        {% endif %}
                        {% if request.user != project.student.user %}
                        <button class="action-button-modern btn-hire" onclick="handleHireNow('{{ project.student.student_name }}', '{{ project.title }}', {{ project.id }})">
                            <div class="btn-icon">
                                <i class="fas fa-user-plus"></i>
                            </div>
                            <div class="btn-content">
                                <span class="btn-title">Hire Now</span>
                                <span class="btn-subtitle">Contact Developer</span>
                            </div>
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% include "accounts/add_student_modal.html" %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle project likes
    document.querySelector('.like-btn-modern')?.addEventListener('click', async function(e) {
        e.preventDefault();
        const projectId = this.dataset.projectId;
        
        try {
            const response = await fetch(`/accounts/project/${projectId}/like/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
            });
            const data = await response.json();
            
            if (data.success) {
                const heartIcon = this.querySelector('.like-icon');
                const likeCount = this.querySelector('.like-count');
                
                if (data.liked) {
                    heartIcon.classList.add('liked');
                } else {
                    heartIcon.classList.remove('liked');
                }
                
                likeCount.textContent = data.likeCount;
            }
        } catch (error) {
            console.error('Error:', error);
        }
    });

    // Handle follow/unfollow
    document.querySelector('.follow-btn-modern')?.addEventListener('click', async function(e) {
        e.preventDefault();
        const studentId = this.dataset.studentId;
        const followText = this.querySelector('.follow-text');
        
        try {
            const response = await fetch(`/accounts/student/${studentId}/follow/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
            });
            const data = await response.json();
            
            if (data.success) {
                const isFollowing = data.following;
                followText.textContent = isFollowing ? 'Following' : 'Follow';
                this.classList.toggle('following', isFollowing);
                this.classList.toggle('not-following', !isFollowing);
                this.dataset.following = isFollowing;
            }
        } catch (error) {
            console.error('Error:', error);
        }
    });
});

// Sidebar functionality
document.addEventListener('DOMContentLoaded', function() {
    const openSidebarBtn = document.getElementById('openSidebarBtn');
    const closeSidebarBtn = document.getElementById('closeSidebarBtn');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const adminSidebar = document.getElementById('adminSidebar');

    function openSidebar() {
        adminSidebar.classList.add('sidebar-open');
        adminSidebar.classList.add('show');
        sidebarOverlay.classList.add('show');
        sidebarOverlay.style.display = 'block';
    }

    function closeSidebar() {
        adminSidebar.classList.remove('sidebar-open');
        adminSidebar.classList.remove('show');
        sidebarOverlay.classList.remove('show');
        sidebarOverlay.style.display = 'none';
    }

    openSidebarBtn.addEventListener('click', openSidebar);
    closeSidebarBtn.addEventListener('click', closeSidebar);
    sidebarOverlay.addEventListener('click', closeSidebar);
});

function recordProjectView(projectId, event) {
    console.log('=== View Recording Started ===');
    console.log('Project ID:', projectId);
    console.log('Event type:', event.type);
    
    try {
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        const csrftoken = getCookie('csrftoken');
        console.log('CSRF token found:', !!csrftoken);
        
        // Find the stat-item for views
        let projectCard = event.target.closest('.project-details-section');
        if (!projectCard && event.target.classList.contains('project-details-section')) {
            projectCard = event.target;
        }
        console.log('Project card found:', !!projectCard);
        
        let viewCountElement = null;
        if (projectCard) {
            const statCards = document.querySelectorAll('.stat-card');
            viewCountElement = Array.from(statCards).find(card => 
                card.querySelector('.stat-icon i').classList.contains('fa-eye')
            )?.querySelector('.stat-number');
            console.log('Current view count:', viewCountElement?.textContent);
        }
        console.log('View count element found:', !!viewCountElement);
        
        const formData = new FormData();
        formData.append('project_id', projectId);
        
        console.log('Sending POST request...');
        fetch('/accounts/record-project-view/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData,
            credentials: 'same-origin'
        })
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Response ok:', response.ok);
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.success && data.newCount !== undefined) {
                console.log('Updating view count to:', data.newCount);
                if (viewCountElement) {
                    viewCountElement.textContent = data.newCount;
                    console.log('View count updated successfully');
                }
            } else {
                console.error('Invalid response data:', data);
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
        });
    } catch (error) {
        console.error('Error in recordProjectView:', error);
    }
    console.log('=== View Recording Completed ===');
}

// Handle Hire Now button click
function handleHireNow(developerName, projectTitle, projectId = null) {
    // If projectId is provided, send notification
    if (projectId) {
        sendHireNotification(projectId, developerName, projectTitle);
        return;
    }
    
    // Fallback for cases without projectId (legacy behavior)
    const message = `Interested in hiring ${developerName} for the project "${projectTitle}"?\n\nThis would typically open a contact form or redirect to a hiring platform.`;
    
    if (confirm(message)) {
        alert('Hire Now functionality would be implemented here. This could redirect to:\n- Contact form\n- External hiring platform\n- Direct messaging system\n- Email contact');
    }
}

// Send hire notification to the project owner
async function sendHireNotification(projectId, developerName, projectTitle) {
    try {
        const response = await fetch(`/accounts/project/${projectId}/hire/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`✅ ${data.message}`);
        } else {
            alert(`❌ ${data.message}`);
        }
    } catch (error) {
        console.error('Error sending hire notification:', error);
        alert('❌ Failed to send hire request. Please try again.');
    }
}
</script>
{% endblock %}